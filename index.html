<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PWA Audio Player</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f8f8f8; }
    button, input { margin: 0.5rem 0; display: block; }
  </style>
</head>
<body>
  <h2>Audio Player with IndexedDB</h2>

  <input type="file" id="fileInput" accept="audio/*">
  <button id="playBtn">▶ Play</button>
  <button id="pauseBtn">⏸ Pause</button>

  <script>
    let audio = new Audio();
    let db;

    const fileInput = document.getElementById("fileInput");
    const playBtn = document.getElementById("playBtn");
    const pauseBtn = document.getElementById("pauseBtn");

    // Open IndexedDB
    const request = indexedDB.open("audioDB", 1);
    request.onupgradeneeded = function (e) {
      db = e.target.result;
      if (!db.objectStoreNames.contains("songs")) {
        db.createObjectStore("songs", { keyPath: "name" });
      }
    };

    request.onsuccess = function (e) {
      db = e.target.result;
      restoreLastPlayedSong();
    };

    // Save selected file to IndexedDB
    fileInput.addEventListener("change", function (e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function () {
        const transaction = db.transaction(["songs"], "readwrite");
        const store = transaction.objectStore("songs");
        const songData = {
          name: file.name,
          blob: file,
        };
        store.put(songData);

        localStorage.setItem("songName", file.name);
        localStorage.setItem("currentTime", "0");
        localStorage.setItem("paused", "true");

        console.log("Saved song to IndexedDB:", file.name);
        setAudioFromBlob(songData.blob);
      };
      reader.readAsArrayBuffer(file); // Just to trigger loading; data isn't used here
    });

    // Load and play song from IndexedDB
    function restoreLastPlayedSong() {
      const songName = localStorage.getItem("songName");
      if (!songName) return;

      const transaction = db.transaction(["songs"], "readonly");
      const store = transaction.objectStore("songs");
      const getRequest = store.get(songName);

      getRequest.onsuccess = function (e) {
        const result = e.target.result;
        if (result && result.blob) {
          setAudioFromBlob(result.blob);
        } else {
          console.warn("No blob found for saved song.");
        }
      };
    }

    // Create new blob URL and set to audio.src
    function setAudioFromBlob(blob) {
      if (audio.src) {
        URL.revokeObjectURL(audio.src);
      }

      const newUrl = URL.createObjectURL(blob);
      audio.src = newUrl;

      const savedTime = parseFloat(localStorage.getItem("currentTime") || "0");
      audio.currentTime = isNaN(savedTime) ? 0 : savedTime;

      const wasPaused = localStorage.getItem("paused") === "true";

      // Only play if user taps play
      playBtn.onclick = () => {
        audio.play().then(() => {
          console.log("Playback started");
        }).catch(err => {
          console.error("Playback failed:", err);
        });
      };

      pauseBtn.onclick = () => {
        audio.pause();
      };
    }

    // Save time and pause state before unload
    window.addEventListener("beforeunload", () => {
      localStorage.setItem("currentTime", audio.currentTime.toString());
      localStorage.setItem("paused", audio.paused.toString());
    });
  </script>
</body>
</html>
