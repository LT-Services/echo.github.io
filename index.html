<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Persistent Music Player</title>
<style>
  /* Reset & base */
  * {
    margin: 0; padding: 0; box-sizing: border-box;
  }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #121212;
    color: #fff;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }
  /* Main content fills above bottom controls */
  .main {
    flex: 1;
    overflow-y: auto;
    padding: 24px 24px 140px; /* bottom space for controls */
    background: linear-gradient(#282828 0%, #121212 300px);
  }
  .header h1 {
    font-size: 48px;
    font-weight: 900;
    margin-bottom: 32px;
  }

  /* Tabs and controls container fixed bottom */
  .bottom-bar {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: #181818;
    border-top: 1px solid #282828;
  }
  /* Now Playing info above tabs */
  .now-playing-info {
    padding: 8px 24px;
    font-weight: 600;
    font-size: 16px;
    color: #dc143c;
    border-bottom: 1px solid #282828;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  /* Playback controls row */
  .playback-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 8px 0;
    gap: 32px;
  }
  .ctrl-btn {
    background: transparent;
    border: none;
    color: #b3b3b3;
    cursor: pointer;
    transition: color 0.2s;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .ctrl-btn:hover {
    color: #fff;
  }
  .ctrl-btn.playing {
    color: #dc143c;
  }
  .ctrl-btn svg {
    width: 24px;
    height: 24px;
    fill: currentColor;
  }

  /* Bottom tab navigation */
  .tab-bar {
    display: flex;
    justify-content: space-around;
    border-top: 1px solid #282828;
  }
  .tab-btn {
    flex: 1;
    padding: 12px 0;
    color: #b3b3b3;
    font-weight: 600;
    font-size: 14px;
    text-align: center;
    cursor: pointer;
    user-select: none;
    transition: background 0.2s, color 0.2s;
  }
  .tab-btn:hover {
    color: #fff;
  }
  .tab-btn.active {
    color: #dc143c;
    background: #282828;
  }

  /* Page content */
  .page-content {
    display: none;
  }
  .page-content.active {
    display: block;
  }

  /* Songs list and others */
  .songs-header, .song-item {
    display: grid;
    grid-template-columns: 50px 1fr 150px 80px;
    gap: 16px;
    padding: 8px 0;
    border-bottom: 1px solid #282828;
    align-items: center;
    font-size: 14px;
    color: #b3b3b3;
  }
  .song-item {
    cursor: pointer;
  }
  .song-item.playing {
    background: #282828;
    color: #fff;
  }
  .song-title {
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }

  .actions button {
    background: transparent;
    border: none;
    color: #b3b3b3;
    cursor: pointer;
    margin-left: 8px;
    font-size: 16px;
  }
  .actions button:hover {
    color: #dc143c;
  }

  /* Responsive tweaks */
  @media (max-width: 600px) {
    .header h1 {
      font-size: 32px;
    }
    .songs-header, .song-item {
      grid-template-columns: 40px 1fr 100px 60px;
    }
  }
</style>
</head>
<body>

<div class="main">
  <div class="header">
    <h1 id="pageTitle">Your Library</h1>
  </div>

  <!-- Library Page -->
  <div id="libraryPage" class="page-content active">
    <div class="songs-header">
      <div>#</div><div>Title</div><div>Size</div><div>Actions</div>
    </div>
    <div id="songsList">No songs yet</div>
  </div>

  <!-- Search Page -->
  <div id="searchPage" class="page-content">
    <input type="file" id="fileInput" multiple accept="audio/*,video/mp4" style="display:none" />
    <button onclick="document.getElementById('fileInput').click()">Upload Songs</button>
    <div id="searchResults"></div>
  </div>
</div>

<!-- Bottom Bar: Now playing info, playback controls, tabs -->
<div class="bottom-bar">
  <div class="now-playing-info" id="nowPlayingInfo">Ready to play</div>
  <div class="playback-controls">
    <button class="ctrl-btn" onclick="prevSong()" title="Previous">
      <svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
    </button>
    <button class="ctrl-btn" id="playPauseBtn" onclick="togglePlay()" title="Play/Pause">
      <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
    </button>
    <button class="ctrl-btn" onclick="nextSong()" title="Next">
      <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
    </button>
  </div>
  <div class="tab-bar">
    <div class="tab-btn active" id="tabLibrary" onclick="showPage('library')">Library</div>
    <div class="tab-btn" id="tabSearch" onclick="showPage('search')">Search</div>
  </div>
</div>

<audio id="audioPlayer"></audio>

<script>
  // Data & State
  let songs = [];
  let currentSongIndex = -1;
  let isPlaying = false;

  const songsList = document.getElementById('songsList');
  const searchPage = document.getElementById('searchPage');
  const libraryPage = document.getElementById('libraryPage');
  const pageTitle = document.getElementById('pageTitle');
  const nowPlayingInfo = document.getElementById('nowPlayingInfo');
  const playPauseBtn = document.getElementById('playPauseBtn');
  const audioPlayer = document.getElementById('audioPlayer');

  const tabLibraryBtn = document.getElementById('tabLibrary');
  const tabSearchBtn = document.getElementById('tabSearch');

  const fileInput = document.getElementById('fileInput');

  // Show selected page and toggle active tab button
  function showPage(page) {
    if (page === 'library') {
      libraryPage.classList.add('active');
      searchPage.classList.remove('active');
      tabLibraryBtn.classList.add('active');
      tabSearchBtn.classList.remove('active');
      pageTitle.textContent = 'Your Library';
    } else if (page === 'search') {
      libraryPage.classList.remove('active');
      searchPage.classList.add('active');
      tabLibraryBtn.classList.remove('active');
      tabSearchBtn.classList.add('active');
      pageTitle.textContent = 'Search';
    }
  }

  // Format file size
  function fmt(bytes) {
    if (!bytes) return '0 B';
    const k = 1024;
    const sizes = ['B','KB','MB','GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
  }

  // IndexedDB setup
  let db;
  function openDb() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open('MusicPlayerDb', 1);
      req.onerror = e => reject(e.target.error);
      req.onsuccess = e => {
        db = e.target.result;
        resolve();
      };
      req.onupgradeneeded = e => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains('songs')) {
          db.createObjectStore('songs', { keyPath: 'id' });
        }
      };
    });
  }

  function addSongToDb(song) {
    return new Promise((resolve, reject) => {
      const tx = db.transaction('songs', 'readwrite');
      const store = tx.objectStore('songs');
      const req = store.add(song);
      req.onsuccess = () => resolve();
      req.onerror = e => reject(e.target.error);
    });
  }

  function getAllSongsFromDb() {
    return new Promise((resolve, reject) => {
      const tx = db.transaction('songs', 'readonly');
      const store = tx.objectStore('songs');
      const req = store.getAll();
      req.onsuccess = e => resolve(e.target.result);
      req.onerror = e => reject(e.target.error);
    });
  }

  function deleteSongFromDb(id) {
    return new Promise((resolve, reject) => {
      const tx = db.transaction('songs', 'readwrite');
      const store = tx.objectStore('songs');
      const req = store.delete(id);
      req.onsuccess = () => resolve();
      req.onerror = e => reject(e.target.error);
    });
  }

  // Render library songs list
  function renderLibrary() {
    if (songs.length === 0) {
      songsList.innerHTML = '<div style="padding: 24px; text-align:center; color:#666;">No songs yet. Upload some!</div>';
      updateNowPlaying();
      return;
    }
    songsList.innerHTML = '';
    songs.forEach((song, i) => {
      const div = document.createElement('div');
      div.className = 'song-item' + (i === currentSongIndex ? ' playing' : '');
      div.title = song.name;
      div.innerHTML = `
        <div>${i+1}</div>
        <div class="song-title" title="${song.name}">${song.name}</div>
        <div>${fmt(song.size)}</div>
        <div class="actions">
          <button onclick="playSong('${song.id}')" title="Play">&#9658;</button>
          <button onclick="downloadSong('${song.id}')" title="Download">&#8681;</button>
          <button onclick="deleteSong('${song.id}')" title="Delete">&times;</button>
        </div>
      `;
      songsList.appendChild(div);
    });
    updateNowPlaying();
  }

  // Update now playing info
  function updateNowPlaying() {
    if (currentSongIndex === -1) {
      nowPlayingInfo.textContent = 'Ready to play';
      playPauseBtn.classList.remove('playing');
    } else {
      nowPlayingInfo.textContent = 'Playing: ' + songs[currentSongIndex].name;
      if (isPlaying) playPauseBtn.classList.add('playing');
      else playPauseBtn.classList.remove('playing');
    }
  }

  // Playback controls
  function playSong(id) {
    const index = songs.findIndex(s => s.id === id);
    if (index === -1) return;
    currentSongIndex = index;

    if (audioPlayer.src) {
      URL.revokeObjectURL(audioPlayer.src);
    }
    const url = URL.createObjectURL(songs[currentSongIndex].blob);
    audioPlayer.src = url;

    audioPlayer.play().then(() => {
      isPlaying = true;
      updateNowPlaying();
      renderLibrary();
    }).catch(console.error);
  }

  function togglePlay() {
    if (isPlaying) {
      audioPlayer.pause();
      isPlaying = false;
    } else {
      if (currentSongIndex === -1 && songs.length > 0) {
        playSong(songs[0].id);
      } else {
        audioPlayer.play().catch(console.error);
        isPlaying = true;
      }
    }
    updateNowPlaying();
    renderLibrary();
  }

  function nextSong() {
    if (songs.length === 0) return;
    currentSongIndex = (currentSongIndex + 1) % songs.length;
    playSong(songs[currentSongIndex].id);
  }

  function prevSong() {
    if (songs.length === 0) return;
    currentSongIndex = (currentSongIndex - 1 + songs.length) % songs.length;
    playSong(songs[currentSongIndex].id);
  }

  function downloadSong(id) {
    const song = songs.find(s => s.id === id);
    if (!song) return;
    const url = URL.createObjectURL(song.blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = song.name;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function deleteSong(id) {
    deleteSongFromDb(id).then(() => {
      const wasPlayingDeleted = currentSongIndex !== -1 && songs[currentSongIndex].id === id;
      songs = songs.filter(s => s.id !== id);
      if (wasPlayingDeleted) {
        audioPlayer.pause();
        currentSongIndex = -1;
        isPlaying = false;
      }
      renderLibrary();
      updateNowPlaying();
    }).catch(console.error);
  }

  // File input handler
  fileInput.addEventListener('change', e => {
    const files = e.target.files;
    handleFiles(files);
    fileInput.value = '';
  });

  function handleFiles(files) {
    Array.from(files).forEach(file => {
      if (!file.type.startsWith('audio/') && !file.type.startsWith('video/')) return;
      const id = `${file.name}-${file.size}-${file.lastModified}`;
      if (songs.find(s => s.id === id)) return; // skip duplicates
      const song = {
        id,
        name: file.name,
        size: file.size,
        blob: file,
        added: Date.now(),
      };
      addSongToDb(song).then(() => {
        songs.push(song);
        renderLibrary();
      }).catch(console.error);
    });
  }

  // Audio ended event to autoplay next
  audioPlayer.addEventListener('ended', () => {
    nextSong();
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', e => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    switch(e.key) {
      case ' ':
        e.preventDefault();
        togglePlay();
        break;
      case 'ArrowRight':
        nextSong();
        break;
      case 'ArrowLeft':
        prevSong();
        break;
    }
  });

  // Initialization
  openDb().then(() => getAllSongsFromDb()).then(storedSongs => {
    songs = storedSongs || [];
    renderLibrary();
  }).catch(console.error);

</script>

</body>
</html>
